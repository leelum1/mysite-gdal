{% extends 'base.html' %}
{% load static %}
{% block head %}
    <meta name="description" content="Trinidad and Tobago Watersheds Map">
    <meta name="keywords" content="Trinidad, Tobago, Watersheds, Map">
    <title>Kevan Lee Lum</title>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css' rel='stylesheet' />
    <style media="screen">
      #map{
        height: 88vh;
        width: 100%;
      }

      .print-maps{
        border: 1px solid black;
        width: 100%;
      }
    </style>
{% endblock head %}
{% block body_block %}
    <section>
      <div id="map"></div>
    </section>

    <section class="my-5" style="text-align:center;">
      <div class="container-fluid" style="border: 1px solid lightgrey;border-radius: 5px;margin:auto;max-width:1000px;">
        <h1 class="my-3">Trinidad and Tobago Watersheds</h1>
        <p>This is an interactive map of the watersheds of Trinidad and Tobago.
          If you do not see any features on the map try re-loading the page.</p>
        <p>Currently I have the watersheds in geojson format, hosted on GitHub.
          The map is displayed with MapboxGL using OpenStreetMap as the base layer.
          In the future, I plan to put the watersheds in a PostGIS database and
          render the map using Leaflet instead of Mapbox. I also instead to add
          more features, making good use of geoDjango and Leaflet. If you have any
          ideas for features you would like to see, send me a message!
        </p>
      </div>
    </section>

    <section>
      <div class="container-fluid">
        <h4 class="mb-3">Printer-friendly Maps</h4>
        <p>These maps are from
          <a href="http://www.adoptarivertt.com" target="_blank">Trinidad's Adopt-a-River Programme</a>.
        </p>
        <div class="row">
          <div class="col-lg-6 col-md-12">
            <a href="{% static 'images/gis/Trinidad_Watersheds.jpg' %}">
              <img class="print-maps" src="{% static 'images/gis/Trinidad_Watersheds.jpg' %}" alt="Trinidad Watersheds">
            </a>
          </div>
          <div class="col-lg-6 col-md-12">
            <a href="{% static 'images/gis/Tobago_Watersheds.jpg' %}">
              <img class="print-maps" src="{% static 'images/gis/Tobago_Watersheds.jpg' %}" alt="Tobago Watersheds">
            </a>
          </div>
        </div>
      </div>

    </section>
{% endblock body_block %}
{% block javascript %}
    <script type="text/javascript">
      $(document).ready(function(){
        const HAS = {1:"North Coast",
               2:"North Oropouche",
               3:"Nariva",
               4:"Ortoire",
               5:"Southern Range",
               6:"Cedros Peninsula",
               7:"South Oropouche",
               8:"Central West Coast",
               9:"Western Peninsula",
               11:"Leeward",
               12:"East Coast",
               13:"Windward",
               14:"Courland",
               15:"Lowlands"};

        mapboxgl.accessToken = 'pk.eyJ1IjoibGVlbHVtMSIsImEiOiJjamFzNHM0cmo0bmduMnFwbHh0MXNweW5jIn0.1fUr70BuY4Kk4BERLB5Pkg';

        var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/basic-v9',
          center: [-61.5, 10.65],
          zoom: 6
        });

        //Constrain map extent
        map.setMaxBounds([[-62.8, 9.5],[-60, 12]]);

        //Scale
        var scale = new mapboxgl.ScaleControl({
            maxWidth: 100,
            unit: 'metric'
        });
        map.addControl(scale);

        //Geolocation control
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }));

        $(document).ready(function(){
          //From d3-queue. Ensure both datasets are loaded and then do stuff
          d3.queue()
              .defer(d3.json, "https://raw.githubusercontent.com/leelum1/geojson/master/Watersheds.geojson")
              .defer(d3.json, "https://raw.githubusercontent.com/leelum1/geojson/master/Rivers.geojson")
              .await(ready);

          function ready(error, watershedData, riversData) {
            if (error) throw error;
              map.addLayer({
                'id': 'Watersheds',
                'type': 'fill',
                'source': {
                  'type': 'geojson',
                  'data': watershedData
                },
                'layout': {
                  'visibility': 'visible',
                },
                'paint': {
                  'fill-color': 'rgba(0, 0, 0, 0)',
                  'fill-outline-color': 'rgba(200, 100, 240, 1)'
                }
              });

            map.addLayer({
                'id': 'Rivers',
                'type': 'line',
                'source': {
                  'type': 'geojson',
                  'data': riversData
                },
                "minzoom": 11,
                "layout": {
                    "line-join": "round",
                    "line-cap": "round",
                    'visibility': 'visible',
                },
                "paint": {
                    "line-color": "#88D5F7",
                    "line-width": 2
                }
              });

            map.addLayer({
              "id": "WatershedsLabels",
              "type": "symbol",
              'source': {
                'type': 'geojson',
                'data': watershedData
              },
              "minzoom": 10,
              "layout": {
                "symbol-placement": "point",
                "text-font": ["Arial Unicode MS Regular"],
                "text-field": '{Name}' + " Watershed",
                "text-size": 11,
                "text-anchor": "bottom",
                "text-max-angle": 30,
                "visibility": 'visible'
              }
            });

            map.addLayer({
                "id": "RiversLabels",
                "type": "symbol",
                'source': {
                  'type': 'geojson',
                  'data': riversData
                },
                "minzoom": 11,
                "layout": {
                  "symbol-placement": "line",
                  "text-font": ["Arial Unicode MS Regular"],
                  "text-field": '{Name}' + " River",
                  "text-size": 11,
                  "text-anchor": "bottom",
                  "text-max-angle": 30,
                  "visibility": 'visible'
                },
                "paint": {
                  "text-color": "#2299CE",
                }
              });

            // Create a popup, but don't add it to the map yet.
            var popup = new mapboxgl.Popup();

            map.on('mouseover', 'Watersheds', function() {
              map.getCanvas().style.cursor = 'pointer';
            });

            map.on('click', 'Watersheds', function(e) {
              var xCoordinate = e.features[0].properties.CentroidX;
              var yCoordinate = e.features[0].properties.CentroidY;
              // Change the cursor style as a UI indicator.

              popup
                .setLngLat([xCoordinate, yCoordinate])
                .setHTML("<p class='watershed'>" + e.features[0].properties.Name + " Watershed</p><table><tr><td>HA</td><td>" + e.features[0].properties.HA + " - " + HAS[e.features[0].properties.HA] + "</td></tr><tr><td>Area</td><td>" + (e.features[0].properties.Area/1000000).toFixed(1) + " km<sup>2</sup></td></tr></table>")
                .addTo(map);
            });

            map.on('mouseleave', 'Watersheds', function() {
              map.getCanvas().style.cursor = '';
            });
          };
        });
      });
    </script>
{% endblock javascript %}
